<!-- Referenced https://www.youtube.com/watch?v=i7uJAOFEd4g -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>CS180 Proj 4a</title>
        <link rel="stylesheet" href="https://cdn.lineicons.com/4.0/lineicons.css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="style.css">
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </head>
    <body>
        
        <div class="wrapper">
            <div id="sidebar"> 
                
                <div class="sidebar-logo">
                    <a href="#title">Navigation</a>
                </div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <button type="button" class="btn btn-light">
                            <a href="#part1">
                                <span>Part 1</span>
                            </a>
                        </button>
                    </li>
                    <li class="sidebar-nav-item">
                        <button type="button" class="btn btn-light">
                            <a href="#part2">
                                <span>Part 2</span>
                            </a>
                        </button>
                    </li>
                    <li class="sidebar-nav-item">
                        <button type="button" class="btn btn-light">
                            <a href="#part3">
                                <span>Part 3</span>
                            </a>
                        </button>
                    </li>
                    <li class="sidebar-nav-item">
                        <button type="button" class="btn btn-light">
                            <a href="#part4">
                                <span>Part 4</span>
                            </a>
                        </button>
                    </li>
                    <li class="sidebar-nav-item">
                        <button type="button" class="btn btn-light">
                            <a href="#part5">
                                <span>Part 5</span>
                            </a>
                        </button>
                    </li>
                    <li class="sidebar-nav-item">
                        <button type="button" class="btn btn-light">
                            <a href="#part6">
                                <span>Conclusion</span>
                            </a>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="main">
              <h1 id="title"> CS180 Project 4a </h1>
                <h2 id="part1"> Part 1: Shoot the Pictures </h2>
                  <div class="text-container"> 
                    <p> 
                        In this section, I took several sets of images for image mosaics and rectifications. For creating image mosaics, I took two images from different angles (left first and then right) 
                        using my phone. To ensure similar exposure through the set, I made sure to use exposure lock on my phone (press and hold the focus box until it shows AE lock). Unfortunately, I only
                        used exposure locks for daytime images. My nightime image set was taken without the exposure lock causing the mosaiced result to have a very obvious seem due to the exposure difference.
                        
                        For rectification, I took images of an quadrilateral object from an angle, so that the object in appeared slanted and distorted in the image. Then, I used a series of operations to rectify 
                        the image, or change the perspective such that the object appears square/rectangular in the image.

                        Here are some examples of the photos taken:
                    </p>
                    
                    <h3 class="image_title"> Images for Image Mosaic </h3>

                    <div class="image_container"> 
                        <div class=image>
                            <figure> 
                              <img src="data/house_1.JPEG", width="400">
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                              <img src="data/house_2.JPEG", width="400">
                            </figure>
                        </div>
                    </div>
                    <div class="image_container"> 
                        <div class=image>
                            <figure> 
                              <img src="data/building_01.JPEG", width="400">
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                              <img src="data/buiilding_02.JPEG", width="400">
                            </figure>
                        </div>
                    </div>
                    <div class="image_container"> 
                        <div class=image>
                            <figure> 
                              <img src="data/car_1.JPEG", width="400">
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                              <img src="data/car_2.JPEG", width="400">
                            </figure>
                        </div>
                    </div>
                    <div class="image_container"> 
                        <div class=image>
                            <figure> 
                              <img src="data/corner_01.JPEG", width="400">
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                              <img src="data/corner_02.JPEG", width="400">
                            </figure>
                        </div>
                    </div>

                    <h3 class="image_title"> Images for Rectification </h3>

                    <div class="three_col"> 
                        <div class=image>
                            <figure> 
                                <img src="data/book.JPEG", width="400">
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                              <img src="data/magnet.jpg", width="400">
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                              <img src="data/cartoon.JPEG", width="400">
                            </figure>
                        </div>
                    </div>
                  </div>

                <h2 id="part2"> Part 2: Recover Homographies" </h2>

                    <p> 
                        Here we want to recover the homographies between the images. To achieve this effect, we need to first define a set of correspondences between the images. Then, we can use the correspondences 
                        to calculate the homographic transformation matrix. 
                    </p>

                    <p>
                        Imagine we have 1 pair of correspondence between the images. Here is how we can find the homograhica transformation matrix.
                        \[
                            \begin{bmatrix}
                                a & b & c \\
                                d & e & f \\
                                g & h & 1 \\
                            \end{bmatrix}

                            \begin{bmatrix}
                                x \\
                                y \\
                                1 \\
                            \end{bmatrix}
                            = 

                            \begin{bmatrix}
                                wx' \\
                                wy' \\
                                w \\        
                            \end{bmatrix}
                        \]

                        Notice that the last line of the matrix multiplication results in 

                        \[
                            \begin{align*}
                                \begin{bmatrix}
                                    g & h & 1
                                \end{bmatrix}
                                \begin{bmatrix}
                                    x \\
                                    y \\
                                    1 \\
                                \end{bmatrix}
                                &= 
                                \begin{bmatrix}
                                    w \\        
                                \end{bmatrix} \\
                                \begin{bmatrix} 
                                    gx & hy & 1 \\
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    w \\        
                                \end{bmatrix} \\

                                gx + hy + 1 &= w
                            \end{align*}
                        \]

                        Then, this system of equations becomes

                        \[
                            \begin{align*}
                                \begin{bmatrix}
                                    ax & by & c \\
                                    dx & ey & f \\
                                    gx & hy & 1 
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    wx' \\
                                    wy' \\
                                    w         
                                \end{bmatrix} \\[10pt]

                                \begin{bmatrix}
                                    ax & by & c \\
                                    dx & ey & f \\
                                    gx & hy & 1 
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    (gx + hy + 1)x' \\
                                    (gx + hy + 1)y' \\
                                    (gx + hy + 1)         
                                \end{bmatrix} \\[10pt]

                                \begin{bmatrix}
                                    ax & by & c \\
                                    dx & ey & f \\
                                    gx & hy & 1 
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    (gxx' + hyx' + x') \\
                                    (gxy' + hyy' + y') \\
                                    (gx + hy + 1)           
                                \end{bmatrix} \\[10pt]

                                \begin{bmatrix}
                                    ax & by & c \\
                                    dx & ey & f
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    (gxx' + hyx' + x') \\
                                    (gxy' + hyy' + y')           
                                \end{bmatrix} \\[10pt]

                                \begin{bmatrix}
                                    ax & by & c & 0 & 0 & 0 & -gxx' & -hyx' \\
                                    0 & 0 & 0 & dx & ey & f & -gxy' & -hyy'
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    x' \\
                                    y'           
                                \end{bmatrix} \\[10pt]

                                \begin{bmatrix}
                                    x & y & 1 & 0 & 0 & 0 & -xx' & -yx' \\
                                    0 & 0 & 0 & x & y & 1 & -xy' & -yy'
                                \end{bmatrix}
                                \begin{bmatrix}
                                    a \\
                                    b \\
                                    c \\
                                    d \\
                                    e \\
                                    f \\
                                    g \\
                                    h
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    x' \\
                                    y'           
                                \end{bmatrix} \\[10pt]


                            \end{align*}
                        \]

                        This is thus the system of equations that if solved with linear solver, will give us the elements in the transformation matrix. However, since there are
                        8 unknowns, we need to construct 8 equations at minimum to solve the system. Each pair of points can give us two equations, so we need at least four correspondences to solve the system.

                        We simply stack each pair of equations on top of each other to create a more determined matrix.

                        \[
                            \begin{align*}
                                \begin{bmatrix}
                                    x_1 & y_1 & 1 & 0 & 0 & 0 & -x_1x_1' & -y_1x_1' \\
                                    0 & 0 & 0 & x_1 & y_1 & 1 & -x_1y_1' & -y_1y_1' \\
                                    x_2 & y_2 & 1 & 0 & 0 & 0 & -x_2x_2' & -y_2x_2' \\
                                    0 & 0 & 0 & x_2 & y_2 & 1 & -x_2y_2' & -y_2y_2' \\
                                    x_3 & y_3 & 1 & 0 & 0 & 0 & -x_3x_3' & -y_3x_3' \\
                                    0 & 0 & 0 & x_3 & y_3 & 1 & -x_3y_3' & -y_3y_3' \\
                                    x_4 & y_4 & 1 & 0 & 0 & 0 & -x_4x_4' & -y_4x_4' \\
                                    0 & 0 & 0 & x_4 & y_4 & 1 & -x_4y_4' & -y_4y_4' \\
                                \end{bmatrix}
                                \begin{bmatrix}
                                    a \\
                                    b \\
                                    c \\
                                    d \\
                                    e \\
                                    f \\
                                    g \\
                                    h
                                \end{bmatrix}
                                &=
                                \begin{bmatrix}
                                    x_1' \\
                                    y_1' \\ 
                                    x_2' \\
                                    y_2' \\
                                    x_3' \\
                                    y_3' \\
                                    x_4' \\
                                    y_4'       
                                \end{bmatrix} \\[10pt]
                            \end{align*}
                        \]
                    
                        However, to improve numerical stability, we may need to create more than 8 correspondences to form an overdetermined linear system. One down side is that we rarely have 
                        an exact solution, so to find a solution, we need to form this as a least squares optimization problem and solve the system this way. 
                    </p>

                <h2 id="part3"> Part 3: Warp the Images </h2>
                    <p>
                        To warp the images according to the homography matrix found using the process described in part 2, we need to follow the following steps with some caution:
                    </p>
                    
                    <ul>
                        <li> 
                            <p> 
                                Use the homography matrix to find the new corners of the image after the homographic transformation.
                                Note that we need to normalize the last row of the coordinates to turn w into 1.
                            </p>
                        </li>
                        <li> 
                            <p> 
                                Use the new four corners and old four corners to find the smallest bounding box. To do this, we need to find the minimum/maximum x and y coordinates of the
                                8 points. Create the final canvas according to this shape.
                            </p>
                        </li>
                        <li> 
                            <p> 
                                The new canvas might not be centered around (0,0), so we need to shift the bottom left corner of the image to (0,0). 
                            </p>
                        </li>
                        <li> 
                            <p> 
                                Get all points enclosed within the new four corners using the polygon function in Python. Use the inverse homography matrix to transform the points back into the
                                original image. Finally use griddata to interpolate the non-integer coordinates. This process should be similar to the one in project 3.
                            </p>
                        </li>
                        <li> 
                            <p> 
                                Now we have warped the image into the perspective described by the homography matrix.
                            </p>
                        </li>
                    </ul>

                <h2 id="part4"> Part 4: Image Rectification </h2>
                    <p> 
                        To rectify the images, we need to define the four corners of the rectangular object and find the correspondences between these points and four corners of a true rectangle. Then we 
                        find the homography matrix and warp the images.
                    </p>
                    
                    <div class="three_col"> 
                        <div class=image>
                            <figure> 
                                <img src="output/book_original.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Book with original corners
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/cartoon_original.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Bag with original corners
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/magnet_original.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Magnet with original corners
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/book_overlay.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Book with new corners
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/cartoon_overlay.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Bag with new corners
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/magnet_overlay.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Magnet with new corners
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/book_rectified.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Book rectified
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/cartoon_rectified.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Bag rectified
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/magnet_rectified.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Magnet rectified
                                </figcaption>
                            </figure>
                        </div>
                    </div>

                <h2 id="part5"> Part 5: Blend the images into a mosaic </h2>
                    <p> 
                        Here is where the fun begins. I can finaly use the sets of images displayed in part 1 to create three beautiful image mosaics. I first warped each image into the perspective 
                        of the second image using the warpImage function from part 3. Then I found the distance transform of each image's polygon (D1 and D2). Using D1 > D2 and D1 < D2, I found the blending
                        mask for the first and second image. I attempted to blend the two images together just using alpha blending. However, the results turned out to have strong artificats at the seams. 
                        Therefore, I decided to use a Laplacian stack for blending using the masks described above. Here are the results.
                    </p>

                    <div class="three_col"> 
                        <div class=image>
                            <figure> 
                                <img src="output/blending/building_original.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Building 1 with points
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/corner_original.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Street corner 1 with points
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/house_original.jpeg", width="400">
                                <figcaption class="caption"> 
                                    House 1 with points
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/building_overlay.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Building 2 with points
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/corner_overlay.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Street corner 2 with points
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/house_overlay.jpeg", width="400">
                                <figcaption class="caption"> 
                                    House 2 with points
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/building_mask1.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Building Mask 1
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/corner_mask1.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Street Corner Mask 1
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/house_mask1.jpeg", width="400">
                                <figcaption class="caption"> 
                                    House Mask 1
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/building_mask2.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Building Mask 2
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/corner_mask2.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Street Corner Mask 2
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/house_mask2.jpeg", width="400">
                                <figcaption class="caption"> 
                                    House Mask 2
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/building_blended.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Building Blended
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/corner_blended.jpeg", width="400">
                                <figcaption class="caption"> 
                                    Street Corner Blended
                                </figcaption>
                            </figure>
                        </div>
                        <div class=image>
                            <figure> 
                                <img src="output/blending/house_blended.jpeg", width="400">
                                <figcaption class="caption"> 
                                    House Blended
                                </figcaption>
                            </figure>
                        </div>
                    </div>
                
                <p> 
                    Here is a set of extra images.
                </p>

                <div class="tri"> 
                    <div class=image>
                        <figure> 
                          <img src="output/blending/car_original.jpeg", width="400">
                          <figcaption class="caption"> 
                            Car 1 with points
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/car_overlay.jpeg", width="400">
                          <figcaption class="caption"> 
                            Car 2 with points
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/car_mask1.jpeg", width="400">
                          <figcaption class="caption"> 
                            Car Mask 1
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/car_mask2.jpeg", width="400">
                          <figcaption class="caption"> 
                            Car Mask 2
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/car_blended.jpeg", width="400">
                          <figcaption class="caption"> 
                            Car Blended
                        </figcaption>
                        </figure>
                    </div>
                </div>

                <p>
                    Here is a failed attempt to blend the images together. The main reason for this was because the differences in exposure between the left and right images, which caused a
                    obvious seam the in the resulting image.
                </p>

                <div class="tri"> 
                    <div class=image>
                        <figure> 
                          <img src="output/blending/street_original.jpeg", width="400">
                          <figcaption class="caption"> 
                            Street 1 with points
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/street_overlay.jpeg", width="400">
                          <figcaption class="caption"> 
                            Street 2 with points
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/street_mask1.jpeg", width="400">
                          <figcaption class="caption"> 
                            Street Mask 1
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/street_mask2.jpeg", width="400">
                          <figcaption class="caption"> 
                            Street Mask 2
                        </figcaption>
                        </figure>
                    </div>
                    <div class=image>
                        <figure> 
                          <img src="output/blending/street_blended.jpeg", width="400">
                          <figcaption class="caption"> 
                            Street Blended
                        </figcaption>
                        </figure>
                    </div>
                </div>
                <h2 id="part6"> Part 6: Conclusion </h2>
                <p>
                    From this part of the project, I learned that using exposure lock is extremely important for blending images, especially for images taken at night. In addition,
                    while it was extremely difficult to warp the images correctly, the debugging process was phenomenal and reminded me the power of pen and paper debugging.
                </p>
            </div>
        </div>
    </body>
</html>
